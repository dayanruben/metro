# compiler-tests

New compiler tests using JetBrains' official compiler testing infrastructure. If possible, write new compiler tests in here! From [this PR](https://github.com/ZacSweers/metro/pull/128).

Essentially, you can have different kinds of tests and then each test is just a `.kt` file. There are a few categories here.

## Creating a new test

Adding a new test is easy! The simple flow is just

1. Add a new test data file. These are `.kt` files under the `src/test/data` dir. There are categories described below.
2. Run `./gradlew :compiler-tests:generateTests` to regenerate tests. This is important, as these files are not automatically picked up otherwise.
3. After running you'll see a new unit test method generated in the relevant class in `src/test/java`, which you can now use to run your test!

If you want to test something our first, you can also run the existing `ir/scratch.kt` or `fir/scratch.kt` tests as a sort of playground. The files are black and you can add whatever code you want to it, run it, and see the dumped output (IR or FIR, respectively) to see what the compiler generates for them. This is super helpful for debugging too.

## Directives

In all of these tests, the biggest way you will modify their behavior is through [directives](https://github.com/JetBrains/kotlin/tree/master/compiler/test-infrastructure#directives). Metro has its own in `MetroDirectives` (and new behaviors can be added as needed here), or you can use many of the [existing directives](https://github.com/JetBrains/kotlin/tree/master/compiler/tests-common-new/tests/org/jetbrains/kotlin/test/directives). They are specified as line comments and can be simple boolean flags like `RENDER_DIAGNOSTICS_FULL_TEXT` or be more complex like disabling to rendering of certain diagnostics with `DIAGNOSTICS: -PROVIDES_OR_BINDS_SHOULD_BE_PRIVATE`. In each of the base tests, you can also configure default directives that you want with `defaultDirectives`. For example, the dump tests are basically diagnostics tests but with the `FIR_DUMP` diagnostic always enabled.

## Setup

Install the Compiler DevKit IntelliJ plugin from [here](https://github.com/JetBrains/kotlin-compiler-devkit).

In short, it helps with working with these tests data files and associated tests in the IDE. This lets you run or debug tests directly from the test data file, as well as apply generate them and auto-apply diffs.

Read its (short) docs on how to use it [here](https://github.com/JetBrains/kotlin-compiler-devkit).

## Categories

### Diagnostic

Create a `.kt` file somewhere under the `test/src/data/diagnostic` directory, rerun the `generateTests` Gradle task, and a new test will be generated for the file. When run, any diagnostics will be injected directly into the file as a sort of [golden value test](https://en.wikipedia.org/wiki/Characterization_test). Note that the _lack_ of a produced golden value can also be a type of validation here, such as cases where you want to test that a diagnostic is _not_ emitted for some certain edge case in code.

There are two categories of diagnostic tests

#### 1. Frontend only

For diagnostics emitted from FIR checkers (i.e. the `dev.zacsweers.metro.compiler.fir.checkers` package). Only the frontend of the compiler is executed for these, so they are extremely fast. Most diagnostics should be this type.

These test files need this directive at the top of their files:

```
// RENDER_DIAGNOSTICS_FULL_TEXT
```

#### 2. Backend

For diagnostics emitted from the backend (i.e., graph validation and IR transformation). The whole compiler is executed for these, so they are not as fast as FIR-only tests. This should almost exclusively be reserved for testing graph validation, which happens in the IR layer.

These test files need this directive at the top of their files:

```
// RUN_PIPELINE_TILL: FIR2IR
// RENDER_IR_DIAGNOSTICS_FULL_TEXT
```

The pipeline can be either `FIR2IR` (if they are expected to error) or `BACKEND` (if they are expected to succeed or only emit warnings).

### Dump

Create a `.kt` file somewhere under the `test/src/data/dump/fir` or `test/src/data/dump/ir` directory, rerun the `generateTests` Gradle... (you get the idea). When run, the entire IR or FIR tree for the `.kt` file will be dumped to a separate file `.fir.txt`. This is extremely helpful to figure out what exactly is being generated by a plugin. Only the frontend is executed for these tests as well. Take care to put the test in the right place. `fir` is purely to test output of `dev/zacsweers/metro/compiler/fir/generators` while `ir` is to test anything emitted during IR transformation.

Dump tests should be used sparingly as they are essentially change detector tests. They should be primarily focused on situations where you need to validate very specific behavior about the shape of generated code.

### Box

These are the bread and butter functional tests.

When run, the file will be compiled and the `box()` function will be executed, expecting `"OK"` as the output. You also have access to `kotlin.test.assert*` functions to validate behavior. These tests will run the entire compiler.

```kotlin
// test code

fun box(): String {
  // functional tests of the above code
  return "OK"
}
```

Note that `FastInitBoxTest` runs all the same box tests with switching providers enabled (`ENABLE_SWITCHING_PROVIDERS`), so every box test automatically gets coverage for both normal and switching provider code paths.

### Reports

Create a `.kt` file under `test/src/data/dump/reports`. These tests verify Metro's diagnostic report outputs (like unmatched exclusions/replacements during contribution merging). Use the `CHECK_REPORTS` directive to specify which report files to verify. The test runs through the full compilation pipeline (FIR + IR) and compares generated reports against golden files. Example:
   ```kotlin
   // CHECK_REPORTS: merging-unmatched-replacements-fir-dev_zacsweers_metro_AppScope

   @DependencyGraph(AppScope::class)
   interface AppGraph
   ```

Expected files are named `<testFile>.<reportName>.txt` (e.g., `MyTest.merging-unmatched-replacements-fir-AppGraph.txt`).
